

import hashlib
import os
# from database_generation import database
database=['1fa745fb18402deeb2c069f7a40f93ea98729305e65d65e0f1cf0e299bf9880b', '40ccfed4ee31237768f3fc01504536d69230eed0edfa29ff34d3c3104aedd617', 'ce94e4f6ccecc48707f7efb4453421d798fe7850e776d5e7cddc9a7f5f3bd701', '12012bf1a81ab6094625921b7173d4577c1cce787cecff3fcaeef6241fb90879', '269eb1215492faf68ace6cfb7de3bcaeea080a87d6edad085d4cccb1c73ae662', 'c0d32426b93b6da7cc8256001bb1ffd807948501224515e71d14f296cb277fa5', '59526c57eb181ab349e6f911b4d533163ac2ba57120e7bc128af8db7353a65ab', '888a178dcd3c3db562d4374bb01af71c3dd6baabce2c75a10dfe1268e7a3a3f4', 'd74cba6b3fcfc147b545e5c6baa4e6ee23b8ecac5a4c15145fb286606111c0f8', '14b0d475fc9465e8c3f2efc9b6981d68093ffb34fa5315edfea0fb0d8c3d4d80']

scanned= {'processName':[],'processID':[],'exe_path':[]};
scan=[]
import psutil
# Iterate over all running process
print("scan running processes(enter 1) - scan a folder or directory(enter 2) - scan entire disk (enter 3)\n")
choice=int(input())

if choice == 1:
    for proc in psutil.process_iter():
        try:
            # Get process name & pid & exe path from process object.
            processName = proc.name()
            processID = proc.pid
            exe_path=proc.exe()
            print(processName , ' ::: ', processID,' ::: ',exe_path)
            scanned['processName'].append(processName)
            scanned['processID'] .append(processID)
            scanned['exe_path'] .append(exe_path)
            scan.append(scanned)
        except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
            pass
    malwares = []
    name=[]

    print("-----------------------------------------------------------------------------------------\n")
    print("scanning for malwares now......\n")
    for i in range(len(scanned['exe_path'])):
        # print(process)
        try:
            exe = scanned['exe_path'][i]
            h = hashlib.sha256(open(exe, 'rb').read()).hexdigest()
            # print (h)
            if h in database:
                pid=scanned['processID'][i]
                p = psutil.Process(pid)
                p.terminate()
                if exe not in malwares:
                    malwares.append(exe)
                    name.append(scanned["processName"][i])
        except:
            pass
    if not len(malwares):
        print("your device is clean\n")
    for i in range(len(malwares)):
        print("there is a malware named {} in the path: {}".format(name[i],malwares[i]))
        print("the scanner killed it successfully \n")
        print("if you want to delete enter 1 and enter 0 if you don't")
        delete = input()
        if delete == 1:
            os.remove(malwares[i])
        print("=====================================================")

elif choice == 2:
    malwares_folders=[]
    directory = input("enter directory: ")
    for root, subdirectories, files in os.walk(directory):
        # for subdirectory in subdirectories:
        #     paths.append(os.path.join(root, subdirectory))
        for file in files:
            if os.path.join(root, file).endswith(".exe"):
                f=os.path.join(root, file)
            try:
                h = hashlib.sha256(open(f, 'rb').read()).hexdigest()
                if h in database:
                    malwares_folders.append(f)
            except:
                pass
    # print(malwares_folders)
    if not len(malwares_folders):
        print("your device is clean\n")

    for m in malwares_folders:
        print("there is a malware in the path: {}".format(m))
        print("if you want to delete enter 1 and enter 0 if you don't")
        delete = input()
        if delete == 1:
            os.remove(m)
        print("=====================================================")

elif choice == 3:
    disks=['D:\\', 'E:\\' , 'C:\\' ]
    print("disks are 'D:\\', 'E:\\' , 'C:\\' choose a disk please or entire system")
    paths=[]
    malwares_folders=[]
    dirs=[]
    directory = input("enter the disk path or write *all* if you want entire system: \n")
    if directory == "all":
        dirs=['D:\\', 'E:\\', 'C:\\']
    else:
        dirs.append(directory)
    for d in dirs:
        for root, subdirectories, files in os.walk(d):
            # for subdirectory in subdirectories:
            #     paths.append(os.path.join(root, subdirectory))
            for file in files:
                if os.path.join(root, file).endswith(".exe"):
                    f = os.path.join(root, file)
                try:
                    h = hashlib.sha256(open(f, 'rb').read()).hexdigest()
                    if h in database:
                        malwares_folders.append(f)
                except:
                    pass
        # print(malwares_folders)
        if not len(malwares_folders):
            print("your device is clean\n")

        for m in malwares_folders:
            print("there is a malware in the path: {}".format(m))
            print("if you want to delete enter 1 and enter 0 if you don't")
            delete = input()
            if delete == 1:
                os.remove(m)
            print("=====================================================")


    print("=====================================================")
